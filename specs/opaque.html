<!DOCTYPE html>
<html lang="en">
<head prefix="og: http://ogp.me/ns#">
  <meta charset="utf-8">
  <title>IOPA</title>
  <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Canonical links -->
  <link rel="canonical" href="https://iopa.io/specs/opaque.html">
  <!-- Alternative links -->
  
    
      <link rel="alternative" hreflang="en" href="https://iopa.io/specs/opaque.html">
    
  
  <!-- Icon -->
  <link rel="apple-touch-icon" sizes="57x57" href="/icon/apple-touch-icon-57x57.png">
  <link rel="apple-touch-icon" sizes="114x114" href="/icon/apple-touch-icon-114x114.png">
  <link rel="apple-touch-icon" sizes="72x72" href="/icon/apple-touch-icon-72x72.png">
  <link rel="apple-touch-icon" sizes="144x144" href="/icon/apple-touch-icon-144x144.png">
  <link rel="apple-touch-icon" sizes="60x60" href="/icon/apple-touch-icon-60x60.png">
  <link rel="apple-touch-icon" sizes="120x120" href="/icon/apple-touch-icon-120x120.png">
  <link rel="apple-touch-icon" sizes="76x76" href="/icon/apple-touch-icon-76x76.png">
  <link rel="apple-touch-icon" sizes="152x152" href="/icon/apple-touch-icon-152x152.png">
  <link rel="icon" type="image/png" href="/icon/favicon-196x196.png" sizes="196x196">
  <link rel="icon" type="image/png" href="/icon/favicon-160x160.png" sizes="160x160">
  <link rel="icon" type="image/png" href="/icon/favicon-96x96.png" sizes="96x96">
  <link rel="icon" type="image/png" href="/icon/favicon-16x16.png" sizes="16x16">
  <link rel="icon" type="image/png" href="/icon/favicon-32x32.png" sizes="32x32">
  <meta name="msapplication-TileColor" content="#2f83cd">
  <meta name="msapplication-TileImage" content="/icon/mstile-144x144.png">
  <!-- CSS -->
  <link rel="stylesheet" href="/build/css/iopa-blue-7615250ef9.css">
  <link href='https://fonts.googleapis.com/css?family=Source+Sans+Pro' rel='stylesheet' type='text/css'>
  <link href="https://fonts.googleapis.com/css?family=Lato:300,400,700" rel="stylesheet" type="text/css">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/docsearch.js/1/docsearch.min.css">
  <!-- RSS -->
  <link rel="alternate" href="/atom.xml" title="IOPA">
  <!-- Open Graph -->
  <meta name="description" content="IOPA Extension Specification: Opaque Streams
Author : Internet of Protocols Alliance 
Copyright : 2016 Internet of Protocols Alliance (IOPA) 
License : Creative Commons Attribution ShareAlike 4.0 Int">
<meta property="og:type" content="website">
<meta property="og:title" content="IOPA">
<meta property="og:url" content="https://iopa.io/specs/opaque.html">
<meta property="og:site_name" content="IOPA">
<meta property="og:description" content="IOPA Extension Specification: Opaque Streams
Author : Internet of Protocols Alliance 
Copyright : 2016 Internet of Protocols Alliance (IOPA) 
License : Creative Commons Attribution ShareAlike 4.0 Int">
<meta property="og:image" content="https://iopa.io/./iopa.png">
<meta property="og:updated_time" content="2016-07-07T03:42:59.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="IOPA">
<meta name="twitter:description" content="IOPA Extension Specification: Opaque Streams
Author : Internet of Protocols Alliance 
Copyright : 2016 Internet of Protocols Alliance (IOPA) 
License : Creative Commons Attribution ShareAlike 4.0 Int">
<meta name="twitter:image" content="https://iopa.io/./iopa.png">
<meta name="twitter:site" content="iopa_io">
<meta property="fb:admins" content="tbd">
  <!-- Google Analytics -->
  
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-TBD-10', 'auto');
  ga('send', 'pageview');
</script>

</head>

<body>
  <div id="container">
    <header id="header" class="wrapper">
  <div id="header-inner" class="inner">
    <h1 id="logo-wrap">
      <a href="/" id="logo">IOPA</a>
    </h1>
    <nav id="main-nav">
      <a href="/docs/" class="main-nav-link">Documentation</a><a href="/components/" class="main-nav-link">Components</a><a href="/news/" class="main-nav-link">News</a><a href="/middleware/" class="main-nav-link">Middleware</a><a href="/specs/" class="main-nav-link">Specifications</a>
      <a href="https://github.com/iopa-io/iopa" class="main-nav-link"><i class="fa fa-github"></i></a>
      <div id="search-input-wrap">
        <div id="search-input-icon">
          <i class="fa fa-search"></i>
        </div>
        <input type="search" id="search-input" placeholder="Search...">
      </div>
    </nav>
    <div id="lang-select-wrap">
      <label id="lang-select-label"><i class="fa fa-globe"></i><span>English</span></label>
      <select id="lang-select" data-canonical="">
        
          <option value="en" selected>English</option>
        
      </select>
    </div>
    <a id="mobile-nav-toggle">
      <span class="mobile-nav-toggle-bar"></span>
      <span class="mobile-nav-toggle-bar"></span>
      <span class="mobile-nav-toggle-bar"></span>
    </a>
  </div>
</header>

    <div id="content-wrap">
  <div id="content" class="wrapper">
    <div id="content-inner">
      <article class="article-container" itemscope itemtype="http://schema.org/Article">
        <div class="article-inner">
          <div class="article">
            <div class="inner">
              <header class="article-header">
                <h1 class="article-title" itemprop="name"></h1>
                <a href="https://github.com/iopa-io/iopa-docs/edit/master/source/specs/opaque.md" class="article-edit-link" title="Improve this doc"><i class="fa fa-pencil"></i></a>
                
              </header>
              <div class="article-content" itemprop="articleBody">
                <p><a href="http://iopa.io"><img src="./iopa.png" alt="IOPA"></a></p>
<h1 id="IOPA-Extension-Specification-Opaque-Streams" class="article-heading"><a href="#IOPA-Extension-Specification-Opaque-Streams" class="headerlink" title="IOPA Extension Specification: Opaque Streams"></a>IOPA Extension Specification: Opaque Streams<a class="article-anchor" href="#IOPA-Extension-Specification-Opaque-Streams" aria-hidden="true"></a></h1><ul>
<li>Author : Internet of Protocols Alliance </li>
<li>Copyright : 2016 Internet of Protocols Alliance (IOPA) </li>
<li>License : <a href="https://creativecommons.org/licenses/by-sa/4.0/" target="_blank" rel="external">Creative Commons Attribution ShareAlike 4.0 International</a></li>
<li>Version : 1.4</li>
</ul>
<h2 id="Contents" class="article-heading"><a href="#Contents" class="headerlink" title="Contents"></a>Contents<a class="article-anchor" href="#Contents" aria-hidden="true"></a></h2><ol>
<li><p><a href="#1-introduction">Introduction</a></p>
</li>
<li><p><a href="#2-definitions">Definitions</a></p>
</li>
<li><p><a href="#3-detection">Detection</a></p>
</li>
<li><p><a href="#4-upgrade">Upgrade</a></p>
</li>
<li><p><a href="#5-consumption">Consumption</a></p>
</li>
<li><p><a href="#6-delegate-signature">Delegate Signature</a></p>
</li>
<li><p><a href="#7-usage">Usage</a></p>
</li>
</ol>
<h2 id="1-Introduction" class="article-heading"><a href="#1-Introduction" class="headerlink" title="1. Introduction"></a>1. Introduction<a class="article-anchor" href="#1-Introduction" aria-hidden="true"></a></h2><p>This document outlines the recommended patterns for using opaque streams through the IOPA interface. It depends on IOPA version 1.0 or later, and uses the extension key mechanics as outlined in CommonKeys.</p>
<h2 id="2-Definitions" class="article-heading"><a href="#2-Definitions" class="headerlink" title="2. Definitions"></a>2. Definitions<a class="article-anchor" href="#2-Definitions" aria-hidden="true"></a></h2><p>Opaque Streams or Opaque Mode - Some servers allow a request to take direct ownership of the underlying connection after the initial HTTP handshake. This gives the application access to a bidirectional communication channel and the application is then responsible for employing its own protocol (e.g. WebSockets) to communicate with the client. Normally this involves sending a 101 response status code.</p>
<h2 id="3-Detection" class="article-heading"><a href="#3-Detection" class="headerlink" title="3. Detection"></a>3. Detection<a class="article-anchor" href="#3-Detection" aria-hidden="true"></a></h2><p>In order for an application to use Opaque it MUST first detect support for the extension.</p>
<h3 id="3-1-Startup" class="article-heading"><a href="#3-1-Startup" class="headerlink" title="3.1 Startup"></a>3.1 Startup<a class="article-anchor" href="#3-1-Startup" aria-hidden="true"></a></h3><p>At startup the server SHOULD specify in the Properties server.Capabilities dictionary if Opaque is supported (see the table below). If the application does not see support for Opaque but does see support for Opaque Streams, it MAY insert a middleware to add Opaque support.</p>
<h3 id="3-2-Per-Request" class="article-heading"><a href="#3-2-Per-Request" class="headerlink" title="3.2 Per Request"></a>3.2 Per Request<a class="article-anchor" href="#3-2-Per-Request" aria-hidden="true"></a></h3><p>The Opaque capable server or middleware inspects each request as it arrives to determine if it is Opaque compatible (e.g. verb, headers, etc.). If so, it marks the request with a specific environment key (see the table below).</p>
<table>
<thead>
<tr>
<th>Object Name</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>opaque.Upgrade</td>
<td>An OpaqueUpgrade Action added by the server if the current request supports Opaque. See Delegate Signature</td>
</tr>
</tbody>
</table>
<h2 id="4-Upgrade" class="article-heading"><a href="#4-Upgrade" class="headerlink" title="4. Upgrade"></a>4. Upgrade<a class="article-anchor" href="#4-Upgrade" aria-hidden="true"></a></h2><p>When an application sees a request that is marked as Opaque capable and decides to upgrade to Opaque, it indicates this to the server or middleware by invoking the provided OpaqueUpgrade Action with parameters and an OpaqueFunc callback. This Action MUST immediately set the response status code to 101 and validate any input parameters and request state. The application then completes the AppFunc Task and allows the request pipeline to unwind.</p>
<p>When the pipeline has unwound to the Opaque server or middleware it SHOULD perform the requested upgrade. Once the upgrade is complete the request has left HTTP processing and transitioned to Opaque processing. The original Environment dictionary and its content are presumed invalid and a new one MUST be provided to the OpaqueFunc callback with the keys listed as required in the table below (see Consumption).</p>
<p>If the upgrade fails then the server or middleware SHOULD terminate the request. There is no guarantee that the OpaqueFunc provided by the application can or will be invoked in these scenarios, but the iopa.CallCancelled CancellationToken MUST be signaled if the callback wont be.</p>
<p>The OpaqueUpgrade parameters dictionary MAY be null if there are no parameters to pass in. If not null, it MUST be mutable and use ordinal key comparison.</p>
<p>In addition to these keys the host, server, middleware, application, etc. may add arbitrary data associated with the Opaque Upgrade to the parameters dictionary. Guidelines for additional keys and a list of commonly defined keys can be found in CommonKeys.</p>
<h2 id="5-Consumption" class="article-heading"><a href="#5-Consumption" class="headerlink" title="5. Consumption"></a>5. Consumption<a class="article-anchor" href="#5-Consumption" aria-hidden="true"></a></h2><p>When the server or middleware invoke the OpaqueFunc it provides a new Opaque Environment dictionary (see Delegate Signature). The Opaque Environment dictionary has the same requirements as the IOPA request Environment dictionary, namely that it MUST be non-null, mutable, use ordinal key comparison, and MUST contain the keys and values where listed as required in the table below.</p>
<table>
<thead>
<tr>
<th style="text-align:center">Required</th>
<th>Object Name</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">Yes</td>
<td>opaque.Stream</td>
<td>A duplex Stream for sending and receiving data.</td>
</tr>
<tr>
<td style="text-align:center">Yes</td>
<td>opaque.Version</td>
<td>The string value 1.0 indicating version 1.0 of this IOPA Opaque extension.</td>
</tr>
<tr>
<td style="text-align:center">Yes</td>
<td>opaque.CallCancelled</td>
<td>A CancellationToken provided by the server to signal that opaque streaming has been canceled/aborted.</td>
</tr>
</tbody>
</table>
<p>In addition to these keys the host, server, middleware, application, etc. may add arbitrary data associated with the Opaque context to the environment dictionary. Guidelines for additional keys and a list of commonly defined keys can be found in CommonKeys</p>
<h2 id="6-Delegate-Signature" class="article-heading"><a href="#6-Delegate-Signature" class="headerlink" title="6. Delegate Signature"></a>6. Delegate Signature<a class="article-anchor" href="#6-Delegate-Signature" aria-hidden="true"></a></h2><p>The opaque stream body delegate signature is as follows:</p>
<p><code>C#</code></p>
<pre><code>using OpaqueUpgrade =
    Action
    &lt;
        IDictionary&lt;string, object&gt;, // Parameters
        Func // OpaqueFunc callback
        &lt;
            IDictionary&lt;string, object&gt;, // Opaque environment
            Task // Complete
        &gt;
    &gt;;

using OpaqueFunc =
    Func
    &lt;
        IDictionary&lt;string, object&gt;, // Opaque Environment
        Task // Complete
    &gt;;
</code></pre><h2 id="7-Usage" class="article-heading"><a href="#7-Usage" class="headerlink" title="7. Usage"></a>7. Usage<a class="article-anchor" href="#7-Usage" aria-hidden="true"></a></h2><p>Once the upgrade is complete the consumer operates their own protocol (e.g. WebSockets) over the given Stream. On completion (success or fail), the application MUST complete or fail the returned Task. The consumer SHOULD NOT close the given Stream, the provider (the server or middleware) owns these and is responsible for any cleanup on completion of the OpaqueFunc. The application SHOULD NOT continue to access the Stream once it completes the returned task.</p>
<p>If the <code>oapaque.CallCancelled</code> CancellationToken is cancelled, the application SHOULD promptly terminate processing and complete the returned Task.</p>

              </div>
              <footer class="article-footer">
                <time class="article-footer-updated" datetime="2016-07-07T03:42:59.000Z" itemprop="dateModified">Last updated: 2016-07-07</time>
                <a href="rest.html" class="article-footer-prev" title="REST Keys"><i class="fa fa-chevron-left"></i><span>Prev</span></a><a href="websocket.html" class="article-footer-next" title="WebSocket"><span>Next</span><i class="fa fa-chevron-right"></i></a>
              </footer>
              
<section id="comments">
  <div id="disqus_thread"></div>
</section>
<script>
  var disqus_shortname = 'iopa';
  var disqus_url = 'https://iopa.io/specs/opaque.html';
  var disqus_title = "";
  var disqus_config = function(){
    this.language = 'en';
  };
  (function(){
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = 'https://go.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>

            </div>
          </div>
          <aside id="article-toc" role="navigation">
            <div id="article-toc-inner">
              <strong class="sidebar-title">Contents</strong>
              <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#IOPA-Extension-Specification-Opaque-Streams"><span class="toc-text">IOPA Extension Specification: Opaque Streams</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Contents"><span class="toc-text">Contents</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-Introduction"><span class="toc-text">1. Introduction</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-Definitions"><span class="toc-text">2. Definitions</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-Detection"><span class="toc-text">3. Detection</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1-Startup"><span class="toc-text">3.1 Startup</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-Per-Request"><span class="toc-text">3.2 Per Request</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-Upgrade"><span class="toc-text">4. Upgrade</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-Consumption"><span class="toc-text">5. Consumption</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-Delegate-Signature"><span class="toc-text">6. Delegate Signature</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-Usage"><span class="toc-text">7. Usage</span></a></li></ol></li></ol>
              <a href="#" id="article-toc-top">Back to Top</a>
            </div>
          </aside>
        </div>
      </article>
      <aside id="sidebar" role="navigation">
  <div class="inner"><strong class="sidebar-title">Specifications</strong><a href="iopa.html" class="sidebar-link">IOPA 1.4</a><a href="appbuilder.html" class="sidebar-link">AppBuilder</a><a href="commonkeys.html" class="sidebar-link">Common Keys</a><a href="rest.html" class="sidebar-link">REST Keys</a><strong class="sidebar-title">Extensions</strong><a href="opaque.html" class="sidebar-link current">Opaque Streams</a><a href="websocket.html" class="sidebar-link">WebSocket</a><strong class="sidebar-title">Third Party</strong><a href="nodekit.html" class="sidebar-link">NodeKit</a></div>
</aside>
    </div>
  </div>
</div>

    <footer id="footer" class="wrapper">
  <div class="inner">
    <div id="footer-copyright">
      Copyright &copy; 2016 <a href="https://iopa.io/" target="_blank">Internet of Protocols Alliance</a><br>
      Documentation licensed under <a href="http://creativecommons.org/licenses/by/4.0/" target="_blank">CC BY 4.0</a>.
    </div>
    <div id="footer-links">
      <a href="https://twitter.com/iopa_io" class="footer-link" target="_blank"><i class="fa fa-twitter"></i></a>
      <a href="https://github.com/iopa-io/iopa" class="footer-link" target="_blank"><i class="fa fa-github"></i></a>
    </div>
  </div>
</footer>

  </div>
  <div id="mobile-nav-dimmer"></div>
  <nav id="mobile-nav">
  <div id="mobile-nav-inner">
    <ul id="mobile-nav-list">
      <a href="/docs/" class="mobile-nav-link">Documentation</a><a href="/components/" class="mobile-nav-link">Components</a><a href="/news/" class="mobile-nav-link">News</a><a href="/middleware/" class="mobile-nav-link">Middleware</a><a href="/specs/" class="mobile-nav-link">Specifications</a>
      <li class="mobile-nav-item">
        <a href="https://github.com/iopa-io/iopa" class="mobile-nav-link" rel="external" target="_blank">GitHub</a>
      </li>
    </ul>
    
      <strong class="mobile-nav-title">Specifications</strong><a href="iopa.html" class="mobile-nav-link">IOPA 1.4</a><a href="appbuilder.html" class="mobile-nav-link">AppBuilder</a><a href="commonkeys.html" class="mobile-nav-link">Common Keys</a><a href="rest.html" class="mobile-nav-link">REST Keys</a><strong class="mobile-nav-title">Extensions</strong><a href="opaque.html" class="mobile-nav-link current">Opaque Streams</a><a href="websocket.html" class="mobile-nav-link">WebSocket</a><strong class="mobile-nav-title">Third Party</strong><a href="nodekit.html" class="mobile-nav-link">NodeKit</a>
    
  </div>
  <div id="mobile-lang-select-wrap">
    <span id="mobile-lang-select-label"><i class="fa fa-globe"></i><span>English</span></span>
    <select id="mobile-lang-select" data-canonical="">
      
        <option value="en" selected>English</option>
      
    </select>
  </div>
</nav>
  <!-- Scripts -->
<script src="/build/js/main-d6635cef24.js"></script>
<script src="https://cdn.jsdelivr.net/retinajs/1.3.0/retina.min.js" async></script>

<!-- Algolia -->

<script type="text/javascript" src="https://cdn.jsdelivr.net/docsearch.js/1/docsearch.min.js"></script>
<script type="text/javascript">
document.getElementById('search-input-wrap').classList.add('on');
docsearch({
  apiKey: 'aad27aa416b2ef8f02bf530f23234e2f',
  indexName: 'iopa',
  inputSelector: '#search-input'
});
</script>


</body>
</html>